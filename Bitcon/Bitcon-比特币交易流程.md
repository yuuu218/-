比特币交易

1.  脚本创建（锁定与解锁）

由于锁定脚本往往含有一个公钥（即比特币地址），所以在大多数比特币应用源代码中，脚本公钥代码便是我们所说的锁定脚本。解锁脚本是一个“解决”或满足被锁定脚本在一个输出上设定的花费条件的脚本，同时它将允许输出被消费。解锁脚本是每一笔比特币交易输出的一部分，而且往往含有一个被用户的比特币钱包（通过用户的私钥）生成的数字签名。也就是我们称为的ScriptSig。

每一个比特币客户端会通过同时执行锁定脚本和解锁脚本来验证一笔交易的正确性。对于比特币交易中的每一个输入，验证软件会先检索输入所指向的UTXO。这个UTXO包含一个定义了花费条件的锁定脚本。之后再读取试图花费这个UTXO的输入中所包含的解锁脚本。

常见类型的比特币交易对应的两种脚本类型如下：

![11](media/fdd53f5a490bc647321b8ab12277cbd5.png)

UTXO：未花费的交易输出，它是比特币世界里的抽象货币，每个UTXO都被一个公钥(钱包地址)锁定，只有持有该公钥对应私钥的人，可以通过私钥签名(解锁)并使用该UTXO。可以把UTXO理解为抽象的纸币，但它的面值不是固定的。

对于公钥与私钥的问题，便是由非对称加密算法产生的一个公私钥对。他人可以将数据用公开的公钥加密后传输给公钥持有人，公钥持有人使用对应的私钥将数据解密，读取信息，通过这种方式，可以保证信息传输的安全性。公钥持有人可以使用私钥对信息签名，然后将信息和签名一起发送给他人，他人可以通过公钥对信息签名进行验证(验证过程类似解密过程)，验证签名信息与发送信息一致，则证明信息是由公钥持有人发出，可以在不暴露公钥持有人身份和私钥的情况下，确保信息来源的可靠性。

签名便对应的是数字签名，也就是哈希运算。

比特币里面的公钥通过两次哈希算法(SHA256)运算得到一个散列值(也叫做哈希)，再经过Base58Check编码生成了我们常见到的比特币的钱包地址。

1.  交易代码语言

比特币脚本语言被称为基于堆栈语言，因为它使用的数据结构被称为堆栈。堆栈可以被理解成为一堆卡片。一个堆栈允许两类操作：推送和弹出。脚本语言通过从左往右处理每个项目的方式执行脚本。数字（常数）被推送至堆栈，操作符向堆栈推送（或移除）一个或多个参数，对它们进行处理，甚至可能会向堆栈推送一个结果。

![12](media/06065c379e7f9669b503bb562f34ae40.png)

比如说如下图中验证软件将锁定和解锁脚本组合起来：

![13](media/64013e4b973417773d7799b72f5aa680.png)

当脚本被执行时，结果是OP_TRUE，从而使得交易有效。不仅该笔交易的输出锁定脚本有效，同时UTXO也能被任何知晓这个运算技巧（知道数字是2）的人所使用。

如果堆栈顶部的结果显示为真（标记为{0x01}）,即为任何非零值或脚本执行后堆栈为空情形，则交易有效。

如果堆栈顶部的结果显示为假（0字节空值，标记为{}）或脚本执行被操作符禁止，如OP_VERIFY、OP_RETURN，或有条件终止如OP_ENDIF，则交易无效。

1.  P2SH

在P2SH中，复杂的锁定脚本被哈希函数取代，当一笔交易试图支付UTXO时，要解锁支付脚本，它必须含有与哈希相匹配的脚本。P2SH脚本示例如下：

![14](media/83d135e2bbf670c38c5d17da6296a344.png)

P2SH的另一重要特征是它能将脚本哈希编译为一个地址，P2SH地址是基于Base58编码的一个含有20个字节哈希的脚本，就像比特币地址是基于Base58编码的一个含有20个字节的公钥。由于P2SH地址采用5作为前缀，这导致基于Base58编码的地址以“3”开头。

P2SH锁定脚本包含一个赎回脚本哈希，该脚本对于赎回脚本本身未提供任何描述。P2SH交易即便在赎回脚本无效的情况下也会被认为有效。

四、交易手续费

交易手续费是指比特币用户在任何比特币交易中可能包含的费用。这笔费用可能由将该交易打包到区块中的矿工来收取。当矿工创建区块模板时，他们有权指定该提案中包含的交易手续费应该发送到何处。

注意会有手续费损失的情况，如果挖到新区块的矿工所获得的奖励少于手续费加区块补贴之和，则未收取的比特币将被永久销毁。

比特币的交易实质上是一堆UTXO的输入和输出的过程，伴随旧的UTXO被消耗，新的UTXO产生，完成了一次又一次的比特币交易。交易的过程由非对称加密和哈希算法进行双重保护，比特币持有者可以放心完成交易而不必担心身份被泄露，交易过程中也消耗了一部分比特币，用于奖励打包交易的矿工，使矿工乐于完成自己维护比特币网络的任务。

参考文献：https://blog.csdn.net/sinat_37138973/article/details/111969030
